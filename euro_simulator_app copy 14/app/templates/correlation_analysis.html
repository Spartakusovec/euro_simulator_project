<!doctype html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Euro Simul치tor</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
    });
});
</script>
</head>
<body>
    <nav class="nav-bar">
        <div class="nav-title">Euro Simul치tor</div>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
            &#9776; <!-- Hamburger icon -->
        </button>
        <div class="nav-links" id="navLinks">
            <a href="{{ url_for('index') }}" class="{{ 'active' if active_page == 'index' }}">Hlavn칤 str치nka</a>
            <a href="{{ url_for('simulation_results') }}" class="{{ 'active' if active_page == 'simulation' }}">V칳sledky Simulace</a>
            <a href="{{ url_for('descriptive_analysis') }}" class="{{ 'active' if active_page == 'analysis' }}">T칳mov치 Anal칳za</a>
            <a href="{{ url_for('player_comparison') }}" class="{{ 'active' if active_page == 'comparison' }}">Porovn치n칤 Hr치캜콢</a>
            <a href="{{ url_for('attribute_distributions') }}" class="{{ 'active' if active_page == 'distributions' }}">Distribuce Atribut콢</a>
            <a href="{{ url_for('correlation_analysis') }}" class="active">Korela캜n칤 Anal칳za</a>
        </div>
        <button id="darkModeToggle" aria-label="Toggle dark mode">游깿</button>
    </nav>

    <div class="container mt-4">
        <h1>{{ title }}</h1>
        
        <div class="card mb-4">
    <form id="correlation-form" method="GET" action="{{ url_for('correlation_analysis') }}">
        <div class="filter-form">
            <div class="form-section">
                <label>Typ grafu:</label>
                <div class="radio-group">
                    <input type="radio" class="btn-check" name="chart_type" id="chart_type_heatmap" value="heatmap" 
                          {% if chart_type == 'heatmap' %}checked{% endif %}>
                    <label class="radio-label" for="chart_type_heatmap">Korela캜n칤 matice</label>
                    
                    <input type="radio" class="btn-check" name="chart_type" id="chart_type_scatter" value="scatter" 
                          {% if chart_type == 'scatter' %}checked{% endif %}>
                    <label class="radio-label" for="chart_type_scatter">Bodov칳 graf</label>
                </div>
            </div>
            
            <div class="form-section">
                <label>Rozsah hr치캜콢:</label>
                <div class="radio-group">
                    <input type="radio" class="btn-check" name="scope" id="scope_all" value="all" 
                          {% if scope == 'all' %}checked{% endif %}>
                    <label class="radio-label" for="scope_all">V코ichni hr치캜i</label>
                    
                    <input type="radio" class="btn-check" name="scope" id="scope_squad" value="squad" 
                          {% if scope == 'squad' %}checked{% endif %}>
                    <label class="radio-label" for="scope_squad">Soupisky</label>
                </div>
            </div>
            
            <div class="form-section">
                <label for="team">T칳m:</label>
                <select class="form-select" id="team" name="team">
                    <option value="">-- V코echny t칳my --</option>
                    {% for team in all_teams %}
                        <option value="{{ team }}" {% if team == selected_team %}selected{% endif %}>
                            {% if get_flag_emoji %}{{ get_flag_emoji(team) }} {% endif %}{{ team }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filter-form position-attribute-row mt-20px">
            <div class="form-section">
                <label>Pozice:</label>
                
                {% for category, positions in position_categories.items() %}
                <div class="position-integrated-row">
                    <div class="position-category-header">
                        <input class="position-category-checkbox" type="checkbox" name="position_category" 
                               id="category_{{ category }}" value="{{ category }}"
                               {% if category in selected_position_categories %}checked{% endif %}>
                        <label class="category-label" for="category_{{ category }}">{{ category }}</label>
                    </div>
                    
                    <div class="position-specifics-container">
                        <div class="checkbox-group">
                            {% for position in all_positions %}
                                {% if position in positions %}
                                    <input class="specific-position-checkbox" type="checkbox" name="position_filter" 
                                        id="position_{{ position|replace(' ', '_')|replace('-', '_') }}" value="{{ position }}"
                                        {% if position in selected_positions %}checked{% endif %}>
                                    <label for="position_{{ position|replace(' ', '_')|replace('-', '_') }}">{{ position }}</label>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="form-section">
                <div id="attributes-content" {% if chart_type == 'scatter' %}style="display: none;"{% endif %}>
                    <label>Atributy pro korelaci:</label>
                    <div class="selection-buttons">
                        <button type="button" class="btn btn-sm btn-secondary" id="selectAllAttributes">Vybrat v코e</button>
                        <button type="button" class="btn btn-sm btn-secondary" id="deselectAllAttributes">Zru코it v칳b캩r</button>
                    </div>
                    
                    {% for group, attrs in attributes_by_group.items() %}
                    <div class="position-integrated-row">
                        <div class="position-category-header">
                            <input class="attribute-category-checkbox" type="checkbox" name="attribute_category" 
                                   id="attr_category_{{ group|replace(' ', '_')|lower }}" value="{{ group }}">
                            <label class="category-label" for="attr_category_{{ group|replace(' ', '_')|lower }}">{{ group }}</label>
                        </div>
                        
                        <div class="position-specifics-container">
                            <div class="checkbox-group">
                                {% for attr in attrs %}
                                <input type="checkbox" name="attributes" id="attr_{{ attr }}" value="{{ attr }}"
                                       class="attribute-checkbox" {% if attr in selected_attributes %}checked{% endif %}>
                                <label for="attr_{{ attr }}">{{ attr.replace('_', ' ').title() }}</label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <small class="form-text text-muted d-block mt-2">Pro korela캜n칤 matici vyberte alespo켿 2 atributy.
                    Je-li ponech치no pr치zdn칠, zobraz칤 se v코echny atributy.</small>
                </div>

                <div id="scatter-options" {% if chart_type != 'scatter' %}style="display: none;"{% endif %}>
                    <label for="x_attribute">X-ov치 osa:</label>
                    <select id="x_attribute" name="x_attribute">
                        <option value="">-- Vyberte atribut --</option>
                        {% for group, attrs in attributes_by_group.items() %}
                            <optgroup label="{{ group }}">
                                {% for attr in attrs %}
                                    <option value="{{ attr }}" {% if attr == x_attribute %}selected{% endif %}>
                                        {{ attr.replace('_', ' ').title() }}
                                    </option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>

                    <label for="y_attribute">Y-ov치 osa:</label>
                    <select id="y_attribute" name="y_attribute">
                        <option value="">-- Vyberte atribut --</option>
                        {% for group, attrs in attributes_by_group.items() %}
                            <optgroup label="{{ group }}">
                                {% for attr in attrs %}
                                    <option value="{{ attr }}" {% if attr == y_attribute %}selected{% endif %}>
                                        {{ attr.replace('_', ' ').title() }}
                                    </option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div> 

        <div class="submit-container">
            <button type="submit" class="btn btn-primary">Zobrazit korelaci</button>
            <button type="button" class="btn btn-secondary" id="resetFilters">Resetovat filtry</button>
        </div>
    </form>
</div>
        
        {% if correlation_matrix_json %}
        <div class="card mb-4">
            <h2>V칳sledky korela캜n칤 anal칳zy 
                {% if selected_players|length > 0 %}
                <span class="badge badge-player-count">{{ selected_players|length }} hr치캜콢</span>
                {% endif %}
            </h2>
            
            <div class="chart-container">
                <div id="correlation-chart" class="chart-correlation-heatmap"></div>
                
                <div id="chart-debug" class="error-message" style="display:none;">
                    <p>Diagnostics for chart rendering:</p>
                    <pre id="debug-info"></pre>
                </div>
            </div>
            
            {% if chart_type == 'heatmap' and attr_stats and selected_attributes|length > 0 %}
            <h3>Statistiky atribut콢</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Atribut</th>
                            <th>Pr콢m캩r</th>
                            <th>Minimum</th>
                            <th>Maximum</th>
                            <th>Po캜et hodnot</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for attr in selected_attributes %}
                            {% if attr in attr_stats %}
                            <tr>
                                <td>{{ attr.replace('_', ' ').title() }}</td>
                                <td class="center">{{ attr_stats[attr].mean }}</td>
                                <td class="center">{{ attr_stats[attr].min }}</td>
                                <td class="center">{{ attr_stats[attr].max }}</td>
                                <td class="center">{{ attr_stats[attr].count }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
                        <h3>Interpretace korelace</h3>
                        <div class="grid-container-responsive gap-20px">
                            <div class="correlation-interpretations">
                                <ul class="list-group list-unstyled-custom">
                                    <li class="correlation-interpretation-item correlation-interpretation-item-alt-bg">
                                        <span>1.0 Perfektn칤 pozitivn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-danger">Perfektn칤</span>
                                    </li>
                                    <li class="correlation-interpretation-item">
                                        <span>0.7 - 0.9 Siln치 pozitivn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-danger">Siln치</span>
                                    </li>
                                    <li class="correlation-interpretation-item correlation-interpretation-item-alt-bg">
                                        <span>0.4 - 0.6 St콏edn칤 pozitivn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-stat-min">St콏edn칤</span>
                                    </li>
                                    <li class="correlation-interpretation-item">
                                        <span>0.1 - 0.3 Slab치 pozitivn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-stat-max">Slab치</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="correlation-interpretations">
                                <ul class="list-group list-unstyled-custom">
                                    <li class="correlation-interpretation-item correlation-interpretation-item-alt-bg">
                                        <span>0 콯치dn치 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-secondary">콯치dn치</span>
                                    </li>
                                    <li class="correlation-interpretation-item">
                                        <span>-0.1 - -0.3 Slab치 negativn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-stat-max">Slab치</span>
                                    </li>
                                    <li class="correlation-interpretation-item correlation-interpretation-item-alt-bg">
                                        <span>-0.4 - -0.6 St콏edn칤 negativn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-stat-min">St콏edn칤</span>
                                    </li>
                                    <li class="correlation-interpretation-item">
                                        <span>-0.7 - -1.0 Siln치 negativn칤 korelace</span>
                                        <span class="badge badge-interpretation badge-interp-danger">Siln치</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endif %}
        
        {% if selected_players|length > 0 %}
        <div class="card mb-4">
            <h2>Seznam vybran칳ch hr치캜콢 ({{ selected_players|length }})</h2>
            <button id="toggleColumns" class="btn btn-sm btn-secondary mb-15px btn-align-end-auto-width">Zobrazit/skr칳t sloupce</button>
            
            <div class="table-responsive">
                <table id="players-table">
                    <thead>
                        <tr>
                            <th class="always-visible">Jm칠no hr치캜e</th>
                            <th class="always-visible">N치rodnost</th>
                            <th class="always-visible">Pozice</th>
                            {% for attr in selected_attributes %}
                                <th class="toggle-column">{{ attr.replace('_', ' ').title() }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for player in selected_players %}
                        <tr>
                            <td>{{ player.player_name }}</td>
                            <td>
                                {% if get_flag_emoji %}
                                    {{ get_flag_emoji(player.nationality) }} 
                                {% endif %}
                                {{ player.nationality }}
                            </td>
                            <td>{{ player.position }}</td>
                            {% for attr in selected_attributes %}
                                <td class="toggle-column">{{ player[attr] }}</td>
                            {% endfor %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div> 

    <script>
        window.validateForm = function() {
            console.log("Validating form...");
            const submitButton = document.querySelector('button[type="submit"]');
            const chartTypeInput = document.querySelector('input[name="chart_type"]:checked');
            const chartType = chartTypeInput ? chartTypeInput.value : null;

            if (!submitButton) {
                console.error("Submit button not found!");
                return;
            }
             if (!chartType) {
                 console.error("Chart type not selected!");
                 submitButton.disabled = true;
                 submitButton.classList.add('btn-secondary');
                 submitButton.classList.remove('btn-primary');
                 submitButton.title = 'Vyberte typ grafu';
                 return;
             }


            let isValid = false;
            if (chartType === 'scatter') {
                const xAttr = document.getElementById('x_attribute')?.value;
                const yAttr = document.getElementById('y_attribute')?.value;
                console.log("Scatter selected. X:", xAttr, "Y:", yAttr);
                isValid = xAttr && yAttr;
                submitButton.title = isValid ? '' : 'Pro bodov칳 graf vyberte atributy pro ob캩 osy (X a Y)';

            } else if (chartType === 'heatmap') {
                const selectedAttributesCount = document.querySelectorAll('input[name="attributes"]:checked').length;
                console.log(`Heatmap selected. Attributes count: ${selectedAttributesCount}`);
                isValid = selectedAttributesCount !== 1; 
                if (isValid) {
                    submitButton.title = selectedAttributesCount === 0 ? 'Zobraz칤 v코echny atributy, pokud nejsou 쮂멳n칠 vybr치ny' : '';
                } else { 
                    submitButton.title = 'Pro korela캜n칤 matici vyberte alespo켿 2 atributy nebo 쮂멳n칠 (pro v코echny)';
                }
            }

            submitButton.disabled = !isValid;
             if (isValid) {
                 submitButton.classList.remove('btn-secondary');
                 submitButton.classList.add('btn-primary');
             } else {
                 submitButton.classList.add('btn-secondary');
                 submitButton.classList.remove('btn-primary');
             }
            console.log("Submit button disabled state:", submitButton.disabled);
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM fully loaded - initializing consolidated script...");

            const form = document.getElementById('correlation-form');
            const chartTypeRadios = document.querySelectorAll('input[name="chart_type"]');
            const scatterOptions = document.getElementById('scatter-options');
            const attributesContent = document.getElementById('attributes-content');
            const positionCategoryCheckboxes = document.querySelectorAll('input.position-category-checkbox');
            const specificPositionCheckboxes = document.querySelectorAll('input[name="position_filter"]');
            const attributeCategoryCheckboxes = document.querySelectorAll('input.attribute-category-checkbox');
            const attributeCheckboxes = document.querySelectorAll('input[name="attributes"]');
            const xAttributeSelect = document.getElementById('x_attribute');
            const yAttributeSelect = document.getElementById('y_attribute');
            const selectAllAttributesBtn = document.getElementById('selectAllAttributes');
            const deselectAllAttributesBtn = document.getElementById('deselectAllAttributes');
            const resetFiltersBtn = document.getElementById('resetFilters');
            const toggleColumnsBtn = document.getElementById('toggleColumns');
            const playersTable = document.getElementById('players-table');
            const chartContainer = document.getElementById('correlation-chart');
            const chartDebugContainer = document.getElementById('chart-debug');
            const debugInfoPre = document.getElementById('debug-info');
            const navBar = document.querySelector('.nav-bar');
            const navToggle = document.getElementById('navToggle'); 
            const navLinks = document.getElementById('navLinks'); 


            const attributesByCategory = {};
            {% for group, attrs in attributes_by_group.items() %}
                attributesByCategory["{{ group }}"] = [{% for attr in attrs %}"{{ attr }}"{% if not loop.last %}, {% endif %}{% endfor %}];
            {% endfor %}

            const positionMapping = {
                 {% for category, positions in position_categories.items() %}
                 "{{ category }}": [{% for position in positions %}"{{ position }}"{% if not loop.last %}, {% endif %}{% endfor %}],
                 {% endfor %}
             };


            function syncAttributeCategoryCheckboxes() {
                attributeCategoryCheckboxes.forEach(categoryCheckbox => {
                    const category = categoryCheckbox.value;
                    const label = categoryCheckbox.nextElementSibling; 
                    const attributesInGroup = attributesByCategory[category] || [];

                    if (!label) return; 

                    label.classList.remove('category-label-checked', 'category-label-indeterminate');

                    if (attributesInGroup.length === 0) {
                        categoryCheckbox.checked = false;
                        categoryCheckbox.indeterminate = false; 
                        return;
                    }

                    let checkedCount = 0;
                    attributesInGroup.forEach(attr => {
                        const checkbox = document.querySelector(`input[name="attributes"][value="${attr}"]`);
                        if (checkbox && checkbox.checked) {
                            checkedCount++;
                        }
                    });

                    const allChecked = checkedCount === attributesInGroup.length;
                    const noneChecked = checkedCount === 0;

                    categoryCheckbox.checked = allChecked;
                    categoryCheckbox.indeterminate = !allChecked && !noneChecked;

                    if (allChecked) {
                        label.classList.add('category-label-checked');
                    } else if (!noneChecked) { 
                        label.classList.add('category-label-indeterminate');
                    }
                });
            }

            function syncPositionCategoryCheckboxes() {
                positionCategoryCheckboxes.forEach(categoryCheckbox => {
                    const category = categoryCheckbox.value;
                    const label = categoryCheckbox.nextElementSibling; 
                    const specificPositions = positionMapping[category] || [];
                    console.log(`[Sync Positions] Checking category: ${category}`);

                    if (!label) {
                        console.warn(`[Sync Positions] Label not found for category: ${category}`);
                        return; 
                    }

                    label.classList.remove('category-label-checked', 'category-label-indeterminate');

                    if (specificPositions.length === 0) {
                        categoryCheckbox.checked = false;
                        categoryCheckbox.indeterminate = false; 
                        return;
                    }

                    let selectedCount = 0;
                    let totalPositions = 0;
                    
                    specificPositions.forEach(position => {
                        const checkbox = document.querySelector(`input[name="position_filter"][value="${position}"]`);
                        if (checkbox) {
                            totalPositions++;
                            if (checkbox.checked) {
                                selectedCount++;
                            }
                        }
                    });

                    console.log(`[Sync Positions] Category ${category}: Selected ${selectedCount}/${totalPositions}`);

                    const allSelected = selectedCount === totalPositions && totalPositions > 0;
                    const noneSelected = selectedCount === 0;

                    categoryCheckbox.checked = allSelected;
                    categoryCheckbox.indeterminate = !allSelected && !noneSelected;

                    if (allSelected) {
                        label.classList.add('category-label-checked');
                        console.log(`[Sync Positions] Category ${category}: All selected, applying category-label-checked`);
                    } else if (!noneSelected) { 
                        label.classList.add('category-label-indeterminate');
                        console.log(`[Sync Positions] Category ${category}: Partially selected, applying category-label-indeterminate`);
                    }
                });
            }

            function updateAttributesBasedOnPositions() {
                 const selectedPositions = Array.from(specificPositionCheckboxes)
                     .filter(cb => cb.checked)
                     .map(cb => cb.value);

                 const hasGoalkeeper = selectedPositions.some(pos => pos === 'Goalkeeper' || pos === 'GK');
                 const hasOutfield = selectedPositions.some(pos => pos !== 'Goalkeeper' && pos !== 'GK');

                 const goalkeeperAttrs = attributesByCategory['Goalkeeping'] || [];
                 const allAttributeValues = Object.values(attributesByCategory).flat();
                 const nonGoalkeeperAttrs = allAttributeValues.filter(attr => !goalkeeperAttrs.includes(attr));

                 syncAttributeCategoryCheckboxes();
                 validateForm();
             }

            function updateChartTypeVisibility(chartType) {
                console.log(`Updating visibility for chart type: ${chartType}`);
                const isScatter = chartType === 'scatter';

                if (scatterOptions) {
                    scatterOptions.style.display = isScatter ? 'block' : 'none';
                    console.log(`Scatter options display set to: ${scatterOptions.style.display}`);
                } else {
                     console.error("Scatter options element not found!");
                }

                if (attributesContent) {
                    attributesContent.style.display = isScatter ? 'none' : 'block';
                    console.log(`Attributes content display set to: ${attributesContent.style.display}`);
                } else {
                    console.error("Attributes content element not found!");
                }
            }


            if (navToggle && navLinks) {
                navToggle.addEventListener('click', () => {
                    navLinks.classList.toggle('active'); 
                });
            } else {
                console.error("Navbar toggle or links container not found!");
            }

            chartTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    updateChartTypeVisibility(this.value);
                    validateForm();
                });
            });

            attributeCategoryCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const category = this.value;
                    const isChecked = this.checked;
                    const attributesInGroup = attributesByCategory[category] || [];

                    attributesInGroup.forEach(attr => {
                        const attrCheckbox = document.querySelector(`input[name="attributes"][value="${attr}"]`);
                        if (attrCheckbox) {
                            attrCheckbox.checked = isChecked;
                        }
                    });
                    syncAttributeCategoryCheckboxes();
                    validateForm();
                });
            });

            attributeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    syncAttributeCategoryCheckboxes(); 
                    validateForm(); 
                });
            });

             positionCategoryCheckboxes.forEach(categoryCheckbox => {
                 categoryCheckbox.addEventListener('change', function() {
                     const category = this.value;
                     const isChecked = this.checked;
                     const specificPositions = positionMapping[category] || [];
                     console.log(`[Category Change] Category: ${category}, New State: ${isChecked}`);

                     specificPositions.forEach(position => {
                         const positionCheckbox = document.querySelector(`input[name="position_filter"][value="${position}"]`);
                         if (positionCheckbox) {
                             console.log(`  Setting position ${position} to ${isChecked}`);
                             positionCheckbox.checked = isChecked;
                         }
                     });

                     const label = this.nextElementSibling;
                     if (label) {
                         label.classList.remove('category-label-checked', 'category-label-indeterminate');
                         
                         if (isChecked) {
                             console.log(`  Setting category ${category} label to checked`);
                             label.classList.add('category-label-checked');
                         }
                     }

                     updateAttributesBasedOnPositions();
                 });
             });

             specificPositionCheckboxes.forEach(checkbox => {
                 checkbox.addEventListener('change', () => {
                     console.log(`[Specific Change] ${checkbox.value} changed. Calling syncPositionCategoryCheckboxes.`);
                     syncPositionCategoryCheckboxes(); 
                     
                     console.log(`[Specific Change] ${checkbox.value} changed. Calling updateAttributesBasedOnPositions.`);
                     updateAttributesBasedOnPositions(); 
                 });
             });

            if (xAttributeSelect) xAttributeSelect.addEventListener('change', validateForm);
            if (yAttributeSelect) yAttributeSelect.addEventListener('change', validateForm);

            if (selectAllAttributesBtn) {
                selectAllAttributesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    attributeCheckboxes.forEach(cb => { cb.checked = true; });
                    syncAttributeCategoryCheckboxes(); 
                    validateForm();
                });
            }
            if (deselectAllAttributesBtn) {
                deselectAllAttributesBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    attributeCheckboxes.forEach(cb => { cb.checked = false; });
                    syncAttributeCategoryCheckboxes(); 
                    validateForm();
                });
            }

            if (resetFiltersBtn) {
                resetFiltersBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log("Resetting filters...");

                    if (form) {
                        const currentChartTypeInput = document.querySelector('input[name="chart_type"]:checked');
                        const chartTypeToRestore = currentChartTypeInput ? currentChartTypeInput.value : 'heatmap';
                        console.log("Chart type to restore after reset:", chartTypeToRestore);

                        form.reset();

                        window.history.replaceState({}, '', window.location.pathname);

                        const heatmapRadio = document.getElementById('chart_type_heatmap');
                        const scatterRadio = document.getElementById('chart_type_scatter');
                        const scopeAllRadio = document.getElementById('scope_all');
                        const teamSelect = document.getElementById('team');

                        if (heatmapRadio) heatmapRadio.checked = (chartTypeToRestore === 'heatmap');
                        if (scatterRadio) scatterRadio.checked = (chartTypeToRestore === 'scatter');
                        if (scopeAllRadio) scopeAllRadio.checked = true; 
                        if (teamSelect) teamSelect.value = ''; 

                        positionCategoryCheckboxes.forEach(cb => cb.checked = false);
                        specificPositionCheckboxes.forEach(cb => cb.checked = false);
                        attributeCategoryCheckboxes.forEach(cb => cb.checked = false);
                        attributeCheckboxes.forEach(cb => cb.checked = false);
                        if (xAttributeSelect) xAttributeSelect.value = '';
                        if (yAttributeSelect) yAttributeSelect.value = '';

                        updateChartTypeVisibility(chartTypeToRestore); 
                        syncAttributeCategoryCheckboxes();
                        syncPositionCategoryCheckboxes();
                        validateForm();

                        console.log("Filters reset complete. Restored chart type:", chartTypeToRestore);
                    }
                });
            }


            if (toggleColumnsBtn) {
                toggleColumnsBtn.addEventListener('click', () => {
                    const toggleColumns = document.querySelectorAll('.toggle-column');
                    if (toggleColumns.length > 0) {
                        const firstCol = toggleColumns[0];
                        const isHidden = firstCol.style.display === 'none' || getComputedStyle(firstCol).display === 'none';
                        const newDisplay = isHidden ? '' : 'none';
                        console.log(`Toggling columns to display: '${newDisplay}'`);
                        toggleColumns.forEach(column => {
                            column.style.display = newDisplay;
                        });
                    }
                });
            }

            if (form) {
                form.addEventListener('submit', function(event) {
                    console.log("Form submit event triggered.");
                    const chartTypeInput = document.querySelector('input[name="chart_type"]:checked');
                    const chartType = chartTypeInput ? chartTypeInput.value : null;

                    let preventSubmit = false;
                    let alertMsg = '';

                    if (!chartType) {
                         preventSubmit = true;
                         alertMsg = 'Vyberte typ grafu.';
                    } else if (chartType === 'scatter') {
                        const xAttr = xAttributeSelect?.value;
                        const yAttr = yAttributeSelect?.value;
                        if (!xAttr || !yAttr) {
                            preventSubmit = true;
                            alertMsg = 'Pro bodov칳 graf mus칤te vybrat atributy pro ob캩 osy (X a Y)';
                        }
                    } else if (chartType === 'heatmap') {
                        const selectedAttributesCount = document.querySelectorAll('input[name="attributes"]:checked').length;
                        if (selectedAttributesCount === 1) {
                            preventSubmit = true;
                            alertMsg = 'Pro korela캜n칤 matici vyberte alespo켿 2 atributy nebo 쮂멳n칠 (pro v코echny).';
                        }
                    }

                    if (preventSubmit) {
                        console.log("Form submission PREVENTED. Reason:", alertMsg);
                        alert(alertMsg);
                        event.preventDefault(); 
                    } else {
                        console.log("Form submission ALLOWED.");
                    }
                });
            } else {
                console.error("Form element #correlation-form not found!");
            }

            const initialChartType = document.querySelector('input[name="chart_type"]:checked')?.value || 'heatmap';
            updateChartTypeVisibility(initialChartType);
            syncAttributeCategoryCheckboxes(); 
            syncPositionCategoryCheckboxes(); 
            validateForm(); 

            {% if correlation_matrix_json %}
                console.log("Chart data JSON exists. Attempting render...");
                try {
                    if (!chartContainer) {
                        throw new Error("Chart container #correlation-chart not found!");
                    }
                    const chartData = {{ correlation_matrix_json|safe }};
                    if (!chartData || !chartData.data || !chartData.layout) {
                         throw new Error("Chart data structure is invalid.");
                    }

                    const mobileMaxWidth = 768;
                    if (window.innerWidth <= mobileMaxWidth) {
                        console.log("Adjusting Plotly layout for mobile.");
                        if (chartData.layout.xaxis && chartData.layout.xaxis.tickfont) {
                            chartData.layout.xaxis.tickfont.size = 7; 
                        } else if (chartData.layout.xaxis) {
                            chartData.layout.xaxis.tickfont = { size: 7 };
                        } else {
                             chartData.layout.xaxis = { tickfont: { size: 7 } };
                        }

                        if (chartData.layout.yaxis && chartData.layout.yaxis.tickfont) {
                            chartData.layout.yaxis.tickfont.size = 7; 
                        } else if (chartData.layout.yaxis) {
                            chartData.layout.yaxis.tickfont = { size: 7 };
                        } else {
                             chartData.layout.yaxis = { tickfont: { size: 7 } };
                        }

                        if (!chartData.layout.margin) chartData.layout.margin = {};
                        chartData.layout.margin.l = 55; 
                        chartData.layout.margin.b = 55; 
                        chartData.layout.margin.t = 30; 
                        chartData.layout.margin.r = 10; 

                        if (chartData.data[0] && chartData.data[0].colorbar) {
                        }
                    }


                    console.log("Chart data parsed:", "Data points:", chartData.data[0]?.z?.length, "Layout title:", chartData.layout?.title);

                    Plotly.newPlot(chartContainer, chartData.data, chartData.layout, {responsive: true})
                        .then(() => console.log("Chart rendered successfully."))
                        .catch(error => {
                            console.error("Plotly rendering error:", error);
                            if (chartDebugContainer && debugInfoPre) {
                                chartDebugContainer.style.display = "block";
                                debugInfoPre.textContent = "Plotly rendering error: " + error.message;
                            }
                        });

                    window.addEventListener('resize', () => {
                         if (chartContainer) {
                             Plotly.Plots.resize(chartContainer);
                         }
                     });

                } catch (e) {
                    console.error("Error processing or rendering chart data:", e);
                    if (chartDebugContainer && debugInfoPre) {
                        chartDebugContainer.style.display = "block";
                        debugInfoPre.textContent = "JS Error: " + e.message + "\nData type: " + (typeof {{ correlation_matrix_json|safe }});
                    }
                }
            {% else %}
                console.log("No chart data available.");
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="info-message">Nen칤 k dispozici 쮂멳n칳 graf. Vyberte atributy a filtrujte data.</div>';
                }
            {% endif %}

            let lastScrollTop = 0;
            const mobileMaxWidthNav = 768; 
            const scrollThresholdNav = 5; 
            if (navBar) {
                window.addEventListener('scroll', function() {
                    if (window.innerWidth <= mobileMaxWidthNav && !navLinks.classList.contains('active')) {
                        let currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        if (currentScrollTop > lastScrollTop && currentScrollTop > navBar.offsetHeight) {
                            if (Math.abs(lastScrollTop - currentScrollTop) > scrollThresholdNav) {
                                navBar.classList.add('nav-hidden');
                            }
                        } else {
                            navBar.classList.remove('nav-hidden');
                        }
                        lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop; 
                    } else {
                        navBar.classList.remove('nav-hidden');
                    }
                }, false);
            }

            console.log("Consolidated script initialization complete.");
        });
    </script>

</body>
</html>